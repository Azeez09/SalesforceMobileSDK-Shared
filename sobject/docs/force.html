<!DOCTYPE html>

<html>
<head>
  <title>force.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="force.html">
                force.js
              </a>
            
              
              <a class="source" href="forcebone.html">
                forcebone.js
              </a>
            
              
              <a class="source" href="forcetk.html">
                forcetk.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>force.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">"use strict"</span>;

(<span class="keyword">function</span>(_, $) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Save a reference to the global object (<code>window</code> in the browser).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> root = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Save the previous value of the <code>Force</code> variable, so that it can be
restored later on, if <code>noConflict</code> is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> previousForce = root.Force;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The top-level namespace. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> Force = <span class="keyword">this</span>.Force = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Runs in <em>noConflict</em> mode, returning the <code>Force</code> variable
to its previous owner. Returns a reference to this Force object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Force.noConflict = <span class="keyword">function</span>() {
        root.Force = previousForce;
        <span class="keyword">return</span> <span class="keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Utility Function to turn methods with callbacks into jQuery promises</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> promiser = <span class="keyword">function</span>(object, methodName, objectName) {
        <span class="keyword">var</span> retfn = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> args = $.makeArray(arguments);
            <span class="keyword">var</span> d = $.Deferred();
            args.push(<span class="keyword">function</span>() {
                d.resolve.apply(d, arguments);
            });
            args.push(<span class="keyword">function</span>() {
                d.reject.apply(d, arguments);
            });
            console.log(<span class="string">"Calling "</span> + objectName + <span class="string">":"</span> + methodName);
            object[methodName].apply(object, args);
            <span class="keyword">return</span> d.promise();
        };
        <span class="keyword">return</span> retfn;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Private forcetk client with promise-wrapped methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> forcetkClient = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Private smartstore client with promise-wrapped methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> smartstoreClient = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Init function
creds: credentials returned by authenticate call
apiVersion: apiVersion to use, when null, v27.0 (Spring&#39; 13) is used</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Force.init = <span class="keyword">function</span>(creds, apiVersion) {
        apiVersion = apiVersion || <span class="string">"v27.0"</span>;
        <span class="keyword">var</span> innerForcetkClient = <span class="keyword">new</span> forcetk.Client(creds.clientId, creds.loginUrl);
        innerForcetkClient.setSessionToken(creds.accessToken, apiVersion, creds.instanceUrl);
        innerForcetkClient.setRefreshToken(creds.refreshToken);
        innerForcetkClient.setUserAgentString(creds.userAgent);

        forcetkClient = <span class="keyword">new</span> Object();
        forcetkClient.create = promiser(innerForcetkClient, <span class="string">"create"</span>, <span class="string">"forcetkClient"</span>);
        forcetkClient.retrieve = promiser(innerForcetkClient, <span class="string">"retrieve"</span>, <span class="string">"forcetkClient"</span>);
        forcetkClient.update = promiser(innerForcetkClient, <span class="string">"update"</span>, <span class="string">"forcetkClient"</span>);
        forcetkClient.del = promiser(innerForcetkClient, <span class="string">"del"</span>, <span class="string">"forcetkClient"</span>);
        forcetkClient.query = promiser(innerForcetkClient, <span class="string">"query"</span>, <span class="string">"forcetkClient"</span>);
        forcetkClient.search = promiser(innerForcetkClient, <span class="string">"search"</span>, <span class="string">"forcetkClient"</span>);
        forcetkClient.metadata = promiser(innerForcetkClient, <span class="string">"metadata"</span>, <span class="string">"forcetkClient"</span>);
        forcetkClient.describe = promiser(innerForcetkClient, <span class="string">"describe"</span>, <span class="string">"forcetkClient"</span>);

        <span class="keyword">if</span> (navigator.smartstore) 
        {
            smartstoreClient = <span class="keyword">new</span> Object();
            smartstoreClient.registerSoup = promiser(navigator.smartstore, <span class="string">"registerSoup"</span>, <span class="string">"smartstoreClient"</span>);
            smartstoreClient.upsertSoupEntriesWithExternalId = promiser(navigator.smartstore, <span class="string">"upsertSoupEntriesWithExternalId"</span>, <span class="string">"smartstoreClient"</span>);
            smartstoreClient.querySoup = promiser(navigator.smartstore, <span class="string">"querySoup"</span>, <span class="string">"smartstoreClient"</span>);
            smartstoreClient.removeFromSoup = promiser(navigator.smartstore, <span class="string">"removeFromSoup"</span>, <span class="string">"smartstoreClient"</span>);
            smartstoreClient.closeCursor = promiser(navigator.smartstore, <span class="string">"closeCursor"</span>, <span class="string">"smartstoreClient"</span>);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2>Force.RestError</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    Force.RestError = <span class="keyword">function</span>(xhr) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>200    “OK” success code, for GET or HEAD request.
201    “Created” success code, for POST request.
204    “No Content” success code, for DELETE request.
300    The value returned when an external ID exists in more than one record. The response body contains the list of matching records.
400    The request couldn’t be understood, usually because the JSON or XML body contains an error.
401    The session ID or OAuth token used has expired or is invalid. The response body contains the message and errorCode.
403    The request has been refused. Verify that the logged-in user has appropriate permissions.
404    The requested resource couldn’t be found. Check the URI for errors, and verify that there are no sharing issues.
405    The method specified in the Request-Line isn’t allowed for the resource specified in the URI.
415    The entity in the request is in a format that’s not supported by the specified method.
500    An error has occurred within Force.com, so the request couldn’t be completed. Contact salesforce.com Customer Support.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.xhr = xhr;
        <span class="keyword">this</span>.status = xhr.status;
        <span class="keyword">try</span> {
            <span class="keyword">this</span>.details = JSON.parse(xhr.responseText);
        }
        <span class="keyword">catch</span> (e) { 
            console.log(<span class="string">"Could not parse responseText:"</span> + e);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2>Force.StoreCache</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>SmartStore-backed key-value cache
Soup elements of the form {key:.., value:...} indexed by key
Fires a ready event when ready and an invalid event if initialization fails</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Force.StoreCache = <span class="keyword">function</span>(soupName) {
        <span class="keyword">this</span>.soupName = soupName;
    };

    _.extend(Force.StoreCache.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return promise which initializes backing soup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="keyword">function</span>() {
            <span class="keyword">if</span> (smartstoreClient == <span class="literal">null</span>) <span class="keyword">return</span>;
            <span class="keyword">var</span> indexSpecs = [{path:<span class="string">"key"</span>, type:<span class="string">"string"</span>}];
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">return</span> smartstoreClient.registerSoup(<span class="keyword">this</span>.soupName, indexSpecs);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Return promise which retrieves cached value for the given key
When fieldlist is not null, the cached value is only returned when it has all the fields specified in fieldlist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        retrieve: <span class="keyword">function</span>(key, fieldlist) {
            <span class="keyword">if</span> (<span class="keyword">this</span>.soupName == <span class="literal">null</span>) <span class="keyword">return</span>;
            <span class="keyword">var</span> querySpec = navigator.smartstore.buildExactQuerySpec(<span class="string">"key"</span>, key);
            <span class="keyword">var</span> result = <span class="literal">null</span>;
            <span class="keyword">return</span> smartstoreClient.querySoup(<span class="keyword">this</span>.soupName, querySpec)
                .then(<span class="keyword">function</span>(cursor) {
                    <span class="keyword">if</span> (cursor.currentPageOrderedEntries.length == <span class="number">1</span>) result = cursor.currentPageOrderedEntries[<span class="number">0</span>].value;
                    <span class="keyword">return</span> smartstoreClient.closeCursor(cursor);
                })
                .then(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>if the cached record doesn&#39;t have all the field we are interested in the return null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (result != <span class="literal">null</span> &amp;&amp; fieldlist != <span class="literal">null</span> &amp;&amp; _.any(fieldlist, <span class="keyword">function</span>(field) { 
                        <span class="keyword">return</span> !_.has(result, field); 
                    })) {
                        console.log(<span class="string">"In StoreCache:retrieve key="</span> + key + <span class="string">":in cache but missing some fields"</span>);
                        result = <span class="literal">null</span>;
                    }
                    console.log(<span class="string">"In StoreCache:retrieve key="</span> + key + <span class="string">":"</span> + (result == <span class="literal">null</span> ? <span class="string">"miss"</span> : <span class="string">"hit"</span>));
                    <span class="keyword">return</span> result;
                });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Return promise which stores key-value in cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        save: <span class="keyword">function</span>(keyValue) {
            <span class="keyword">if</span> (<span class="keyword">this</span>.soupName == <span class="literal">null</span>) <span class="keyword">return</span>;
            console.log(<span class="string">"In StoreCache:save key="</span> + keyValue.key);
            <span class="keyword">return</span> smartstoreClient.upsertSoupEntriesWithExternalId(<span class="keyword">this</span>.soupName, [ keyValue ], <span class="string">"key"</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Return promise which stores several key-value in cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        saveAll: <span class="keyword">function</span>(arrayKeyValue) {
            <span class="keyword">if</span> (<span class="keyword">this</span>.soupName == <span class="literal">null</span>) <span class="keyword">return</span>;
            console.log(<span class="string">"In StoreCache:saveAll arrayKeyValue.length="</span> + arrayKeyValue.length);
            <span class="keyword">return</span> smartstoreClient.upsertSoupEntriesWithExternalId(<span class="keyword">this</span>.soupName, arrayKeyValue, <span class="string">"key"</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Return promise which deletes key-value from cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        remove: <span class="keyword">function</span>(key) {
            <span class="keyword">if</span> (<span class="keyword">this</span>.soupName == <span class="literal">null</span>) <span class="keyword">return</span>;
            console.log(<span class="string">"In StoreCache:remove key="</span> + key);
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">var</span> querySpec = navigator.smartstore.buildExactQuerySpec(<span class="string">"key"</span>, key);
            <span class="keyword">return</span> smartstoreClient.querySoup(<span class="keyword">this</span>.soupName, querySpec)
                .then(<span class="keyword">function</span>(cursor) {
                    <span class="keyword">return</span> cursor.currentPageOrderedEntries.length == <span class="number">1</span> 
                        ? smartstoreClient.removeFromSoup(that.soupName, [cursor.currentPageOrderedEntries[<span class="number">0</span>]._soupEntryId])
                        : <span class="literal">null</span>;
                    
                })
                .then(<span class="keyword">function</span>(cursor) {
                    <span class="keyword">return</span> smartstoreClient.closeCursor(cursor);
                })
                .then(<span class="keyword">function</span>() { 
                    <span class="keyword">return</span> <span class="literal">null</span>;
                });
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2>Force.SObjectType</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Represent the meta-data of a SObject type on the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Force.SObjectType = <span class="function"><span class="keyword">function</span> <span class="params">(sobjectType, cache)</span> {</span>
        <span class="keyword">this</span>.sobjectType = sobjectType;
        <span class="keyword">this</span>.cache = cache;
    };

    _.extend(Force.SObjectType.prototype, {
        fetch: <span class="keyword">function</span>(options) {
            <span class="keyword">var</span> options = options || {};
            <span class="keyword">var</span> wasReadFromCache = <span class="literal">false</span>;
            <span class="keyword">var</span> that = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Cache actions helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> cacheRetrieve = <span class="keyword">function</span>() { 
                <span class="keyword">return</span> that.cache.retrieve(that.sobjectType)
                    .then(<span class="keyword">function</span>(data) { 
                        wasReadFromCache = (data != <span class="literal">null</span>); 
                        <span class="keyword">return</span> data;
                    })
            };

            <span class="keyword">var</span> cacheSave = <span class="keyword">function</span>(data) {
                <span class="keyword">return</span> that.cache.save({key:that.sobjectType, value:data})
                    .then(<span class="keyword">function</span>() { 
                        <span class="keyword">return</span> data;
                    })
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Server action helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> serverDescribeUnlessCached = <span class="keyword">function</span>(data) { 
                <span class="keyword">return</span> data == <span class="literal">null</span> ? forcetkClient.describe(that.sobjectType) : data; 
            };

            <span class="keyword">var</span> promise = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>No cache is setup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">this</span>.cache == <span class="literal">null</span>) {
                promise = serverDescribeUnlessCached(<span class="literal">null</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Cache is setup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">else</span> {
                promise = cacheRetrieve()
                    .then(serverDescribeUnlessCached)
                    .then(cacheSave);
            }

            promise = promise
                .done(<span class="keyword">function</span>(data) {
                    that.attributes = data;
                    <span class="keyword">if</span> (options.success) options.success(data);
                })
                .fail(options.error);
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2>Force.syncSObject</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Helper method to do any single record CRUD operations with Salesforce REST API
Returns a promise
See forcebone.js&#39;s Force.SObject for an example</p>
<p>method: create, read, delete or update
sobjectType: record type
id: record id (null for create)
attributes: record attributes given by a map of field name to value
options: map with some or all of the following
<em> fieldlist:<fields>       for read: fields to fetch for read or to save for update, otherwise full record is fetched or saved
</em> refetch:<boolean>        for create: update to refetch the record following the save (useful in case of calculated fields)
* cache:<boolean>          for read: when a cache is specified, a cached record data is returned if found (and if it has all the fields listed in options.fieldlist)
cache: cache into which created/read/updated/deleted record should be cached</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Force.syncSObject = <span class="keyword">function</span>(method, sobjectType, id, attributes, options, cache) {
        console.log(<span class="string">"In Force.syncObject:method="</span> + method + <span class="string">" id="</span> + id);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Cache actions helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> wasReadFromCache = <span class="literal">false</span>;
        <span class="keyword">var</span> cacheRetrieveIfApplicable  = <span class="keyword">function</span>() { 
            <span class="keyword">if</span> (cache != <span class="literal">null</span> &amp;&amp; options.cache) {
                <span class="keyword">return</span> cache.retrieve(id, options.fieldlist)
                    .then(<span class="keyword">function</span>(data) { 
                        wasReadFromCache = (data != <span class="literal">null</span>); 
                        <span class="keyword">return</span> data; 
                    });
            }
            <span class="keyword">else</span> {
                <span class="keyword">var</span> d = $.Deferred();
                d.resolve(<span class="literal">null</span>);
                <span class="keyword">return</span> d.promise();
            }
        };

        <span class="keyword">var</span> cacheSaveIfApplicable = <span class="keyword">function</span>(data) { 
            <span class="keyword">if</span> (cache != <span class="literal">null</span> &amp;&amp;  !wasReadFromCache) {
                <span class="keyword">return</span> cache.save({key:data.Id, value:data})
                    .then(<span class="keyword">function</span>() { 
                        <span class="keyword">return</span> data; 
                    });
            }
            <span class="keyword">else</span> {
                <span class="keyword">return</span> data;
            }
        };

        <span class="keyword">var</span> cacheRemoveIfApplicable = <span class="keyword">function</span>(data) {
            <span class="keyword">return</span> cache != <span class="literal">null</span> ? cache.remove(id) : <span class="literal">null</span>;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Server actions helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> serverCreate   = <span class="keyword">function</span>() { 
            <span class="keyword">return</span> forcetkClient.create(sobjectType, _.omit(attributes, <span class="string">'Id'</span>))
                .then(<span class="keyword">function</span>(resp) {
                    <span class="keyword">return</span> _.extend(attributes, {Id: resp.id});
                }) 
        };

        <span class="keyword">var</span> serverRetrieve = <span class="keyword">function</span>() { 
            <span class="keyword">return</span> forcetkClient.retrieve(sobjectType, id, options.fieldlist)
                .then(<span class="keyword">function</span>(resp) {
                    <span class="keyword">return</span> _.omit(resp, <span class="string">"attributes"</span>);
                });
        };

        <span class="keyword">var</span> serverUpdate   = <span class="keyword">function</span>() { 
            <span class="keyword">var</span> attributesToSave = options.fieldlist != <span class="literal">null</span> ? _.pick(attributes, options.fieldlist) : attributes;
            <span class="keyword">return</span> forcetkClient.update(sobjectType, id, attributesToSave)
                .then(<span class="keyword">function</span>(resp) { 
                    <span class="keyword">return</span> attributes; 
                }) 
        };

        <span class="keyword">var</span> serverDelete   = <span class="keyword">function</span>() { 
            <span class="keyword">return</span> forcetkClient.del(sobjectType, id)
                .then(<span class="keyword">function</span>(resp) { 
                    <span class="keyword">return</span> <span class="literal">null</span>;
                }) 
        };

        <span class="keyword">var</span> serverRefetchIfRequested  = <span class="keyword">function</span>(data) { 
            <span class="keyword">return</span> options.refetch ? serverRetrieve() : data; 
        };

        <span class="keyword">var</span> serverRetrieveUnlessCached = <span class="keyword">function</span>(data) { 
            <span class="keyword">return</span> !wasReadFromCache ? serverRetrieve() : data; 
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Chaining promises that return either a promise or created/upated/reda model attributes or null in the case of delete</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> promise = <span class="literal">null</span>;
        <span class="keyword">switch</span>(method) {
        <span class="keyword">case</span> <span class="string">"create"</span>: promise = serverCreate().then(serverRefetchIfRequested).then(cacheSaveIfApplicable); <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">"read"</span>:   promise = cacheRetrieveIfApplicable().then(serverRetrieveUnlessCached).then(cacheSaveIfApplicable); <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">"update"</span>: promise = serverUpdate().then(serverRefetchIfRequested).then(cacheSaveIfApplicable); <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">"delete"</span>: promise = serverDelete().then(cacheRemoveIfApplicable); <span class="keyword">break</span>;
        }
        <span class="keyword">return</span> promise;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h2>Force.fetchSObjects</h2>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Helper method to fetch a collection of SObjects defined by a SOQL query, a SOSL search of or the MRU of an sobject type
Return promise </p>
<p>config: {type:&quot;soql&quot;, query:&quot;<soql query>&quot;} or {type:&quot;sosl&quot;, query:&quot;<sosl query>&quot;} or {type:&quot;mru&quot;, sobjectType:&quot;<sobject type>&quot;, fieldlist:&quot;<fields to fetch>&quot;}
cache: cache into which fetched records should be cached</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Force.fetchSObjects = <span class="keyword">function</span>(config, cache) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Cache action helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> cacheSaveIfApplicable = <span class="keyword">function</span>(records) { 
            <span class="keyword">if</span> (cache != <span class="literal">null</span>) {
                <span class="keyword">var</span> keyValues = _.map(records, <span class="keyword">function</span>(record) { 
                    <span class="keyword">return</span> {key:record.Id, value:_.omit(record, <span class="string">"attributes"</span>)}; 
                });
                <span class="keyword">return</span> cache.saveAll(keyValues)
                    .then(<span class="keyword">function</span>() { 
                        <span class="keyword">return</span> records; 
                    });
            }
            <span class="keyword">else</span> {
                <span class="keyword">return</span> records
            }
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Server actions helper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> serverSoql = <span class="keyword">function</span>(soql) { 
            <span class="keyword">return</span> forcetkClient.query(soql)
                .then(<span class="keyword">function</span>(resp) { 
                    <span class="keyword">return</span> resp.records; 
                });
        };

        <span class="keyword">var</span> serverSosl = <span class="keyword">function</span>(sosl) {
            <span class="keyword">return</span> forcetkClient.search(sosl)
        };

        <span class="keyword">var</span> serverMru = <span class="keyword">function</span>(sobjectType, fieldlist) {
            <span class="keyword">return</span> forcetkClient.metadata(sobjectType)
                .then(<span class="keyword">function</span>(resp) {
                    <span class="keyword">var</span> soql = <span class="string">"SELECT "</span> + fieldlist.join(<span class="string">","</span>) 
                        + <span class="string">" FROM "</span> + sobjectType
                        + <span class="string">" WHERE Id IN ('"</span> + _.pluck(resp.recentItems, <span class="string">"Id"</span>).join(<span class="string">"','"</span>) + <span class="string">"')"</span>;
                    <span class="keyword">return</span> serverSoql(soql);
                });
        };

        <span class="keyword">var</span> promise = <span class="literal">null</span>;
        <span class="keyword">switch</span>(config.type) {
        <span class="keyword">case</span> <span class="string">"soql"</span>: promise = serverSoql(config.query).then(cacheSaveIfApplicable); <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">"sosl"</span>: promise = serverSosl(config.query).then(cacheSaveIfApplicable); <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">"mru"</span>:  promise = serverMru(config.sobjectType, config.fieldlist).then(cacheSaveIfApplicable); <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>XXX what if we fall through the switch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }

        <span class="keyword">return</span> promise;
    };
})
.call(<span class="keyword">this</span>, _, $);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

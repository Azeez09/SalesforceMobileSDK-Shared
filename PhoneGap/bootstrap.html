<!DOCTYPE html>
<html>
    <head>
        <title>VisualForce Bootstrap Page with OAuth Plugin</title>
        
        <link rel="stylesheet" type="text/css" href="SFUtility.css" />
        
        <script type="text/javascript" src="phonegap-1.2.0.js"></script>
        <script type="text/javascript" src="jquery/jquery-1.6.2.min.js"></script>
        <script type="text/javascript" src="SalesforceOAuthPlugin.js"></script>
        <script type="text/javascript" src="SFUtility.js"></script>
        
        <script type="text/javascript" src="bootconfig.js"></script>
        
        <script type="text/javascript">
        
        /**
         * JQuery's "ready" function.  This will execute once JQuery is successfully loaded.
         */
        $(function() {
            logToConsole("jQuery is ready");
            document.addEventListener("deviceready", onDeviceReady,false);
            logToConsole("Added onDeviceReady event listener.");
        });
        
        /**
         * Handler for PhoneGap's "deviceready" event, signifying that PhoneGap is successfully
         * loaded.
         */
        function onDeviceReady() {
            logToConsole("onDeviceReady called: PhoneGap is ready.");
            
            // Validate the start data configuration.
            if (!isValidStartData(startData)) {
                return;
            }
            
            if (startData.shouldAuthenticate) {
                // Authenticate via the Salesforce OAuth plugin.
                var oauthProperties = new OAuthProperties(remoteAccessConsumerKey, 
                                                          oauthRedirectURI, 
                                                          oauthScopes, 
                                                          autoRefreshOnForeground);
                SalesforceOAuthPlugin.authenticate(loginSuccess, loginFailure, oauthProperties);
            } else {
                if (startData instanceof LocalAppStartData) {
                    loadUrl(buildLocalUrl(startData.appStartUrl));
                } else {
                    loadUrl(startData.appStartUrl);
                }
            }
        }
            
        /**
         * Validates that the start data conforms to the business rules.
         */
        function isValidStartData(startData) {
            if (!(startData instanceof LocalAppStartData || startData instanceof RemoteAppStartData)) {
                logError("startData is not a valid object type.  Expecting LocalAppStartData or RemoteAppStartData.");
                return false;
            }
            
            if (startData instanceof RemoteAppStartData
                && startData.isAbsoluteUrl === false
                && startData.shouldAuthenticate === false) {
                logError("startData.isAbsoluteUrl and startData.shouldAuthenticate cannot both be false for a remote app.  "
                         + "The instance URL determined from authentication is used to build the absolute URL.");
                return false;
            }
            
            return true;
        }
            
        /**
         * Success callback for the SalesforceOAuthPlugin.authenticate() method.
         */
        function loginSuccess(oauthCredentials) {
            logToConsole("loginSuccess");
            var fullAppUrl;
            if (startData instanceof LocalAppStartData) {
                fullAppUrl =  buildLocalUrl(startData.appStartUrl);
            } else if (startData instanceof RemoteAppStartData) {
                if (startData.isAbsoluteUrl) {
                    fullAppUrl = startData.appStartUrl;
                } else {
                    fullAppUrl = buildAppUrl(oauthCredentials.instanceUrl, startData.appStartUrl);
                }
            }
            logToConsole("fullAppUrl: " + fullAppUrl);
            loadUrl(fullAppUrl);
        }
            
        /**
         * Error callback for the SalesforceOAuthPlugin.authenticate() method.
         * TODO: Is there more that we'd want to do here?
         */
        function loginFailure(result) {
            logError("loginFailure: " + result);
        }
            
        </script>
    </head>
    <body>
        <div id="main">
            <h1>Loading...</h1>
            <fieldset id="errors" class="logWindow">
                <legend>Errors</legend>
            </fieldset>
            <fieldset id="console" class="logWindow">
                <legend>Debug Console</legend>
            </fieldset>
        </div>
    </body>
</html>
